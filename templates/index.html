<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RafLocalizer - Transcript Extractor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">
                <i class="fab fa-youtube"></i>
            </div>
            <span class="logo-text">Raf<span class="accent">Localizer</span></span>
        </div>
        <div class="header-actions">
            <!-- Model Selector -->
            <div class="model-selector" id="model-selector">
                <button class="model-btn" id="model-btn">
                    <span class="status-dot"></span>
                    <span id="current-model-name">Loading...</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="model-dropdown" id="model-dropdown">
                    <!-- Models will be injected here -->
                </div>
            </div>
            <span class="dev-badge"><i class="fas fa-code"></i> DEV MODE</span>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Panel: Video Grid -->
        <div class="videos-panel">
            <div class="panel-header">
                <h2><i class="fas fa-video"></i> Select Videos</h2>
                <div class="controls">
                    <button class="btn btn-ghost" id="refresh-btn">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="btn btn-ghost" id="select-all-btn">
                        <i class="far fa-check-square"></i> All
                    </button>
                </div>
            </div>

            <div class="search-container">
                <i class="fas fa-search"></i>
                <input type="text" id="search-input" placeholder="Search videos...">
            </div>

            <div class="video-grid" id="video-grid">
                <!-- Videos injected here -->
            </div>

            <div class="loading-spinner" id="loading">
                <div class="spinner"></div>
                <p>Loading videos...</p>
            </div>
        </div>

        <!-- Right Panel: Transcript -->
        <div class="transcript-panel" id="transcript-panel">
            <div class="panel-header">
                <h2><i class="fas fa-file-alt"></i> Transcripts</h2>
                <button class="btn btn-ghost" id="close-panel">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="transcript-content" id="transcript-content">
                <div class="empty-state">
                    <i class="fas fa-hand-pointer"></i>
                    <p>Select videos and click "Get Transcripts" to extract</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button class="fab-button" id="extract-btn" disabled>
        <i class="fas fa-magic"></i>
        <span>Get Transcripts</span>
        <span class="count" id="selected-count">0</span>
    </button>

    <script>
        // State
        let selectedVideos = new Map(); // Map<id, {title, thumbnail}>
        const videoGrid = document.getElementById('video-grid');
        const loading = document.getElementById('loading');
        const extractBtn = document.getElementById('extract-btn');
        const selectedCount = document.getElementById('selected-count');
        const transcriptPanel = document.getElementById('transcript-panel');
        const transcriptContent = document.getElementById('transcript-content');
        const searchInput = document.getElementById('search-input');

        // Load videos on start
        async function loadVideos(isSearch = false) {
            loading.style.display = 'flex';
            videoGrid.innerHTML = '';

            const endpoint = isSearch
                ? `/api/channel/search?q=${encodeURIComponent(searchInput.value)}`
                : '/api/channel/videos';

            try {
                const res = await fetch(endpoint);
                const data = await res.json();

                if (data.error) {
                    videoGrid.innerHTML = `<div class="error-state"><i class="fas fa-exclamation-circle"></i><p>${data.error}</p></div>`;
                    return;
                }

                renderVideos(data.videos);
            } catch (err) {
                videoGrid.innerHTML = `<div class="error-state"><i class="fas fa-exclamation-circle"></i><p>Failed to load videos</p></div>`;
            } finally {
                loading.style.display = 'none';
            }
        }

        function renderVideos(videos) {
            videos.forEach(video => {
                const card = document.createElement('div');
                card.className = 'video-card';
                card.dataset.id = video.video_id;
                card.innerHTML = `
                    <div class="thumbnail">
                        <img src="${video.thumbnail_url}" alt="${video.title}">
                        <span class="duration-badge">${formatDuration(video.duration)}</span>
                        <div class="check-overlay">
                            <i class="fas fa-check"></i>
                        </div>
                    </div>
                    <div class="video-info">
                        <p class="video-title">${video.title}</p>
                        <span class="video-meta">${formatViewCount(video.view_count)} views â€¢ ${formatRelativeTime(video.published_at)}</span>
                    </div>
                `;

                card.addEventListener('click', () => toggleVideo(video, card));
                videoGrid.appendChild(card);
            });
        }

        // Format ISO 8601 duration (PT7M11S) to readable format (7:11)
        function formatDuration(duration) {
            if (!duration) return '0:00';

            const match = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
            if (!match) return '0:00';

            const hours = parseInt(match[1]) || 0;
            const minutes = parseInt(match[2]) || 0;
            const seconds = parseInt(match[3]) || 0;

            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } else {
                return `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // Format view count like YouTube (1K, 1.5M, etc.)
        function formatViewCount(count) {
            const num = parseInt(count) || 0;
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
            }
            return num.toString();
        }

        // Format relative time like YouTube (1 hour ago, 2 days ago, etc.)
        function formatRelativeTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHour = Math.floor(diffMin / 60);
            const diffDay = Math.floor(diffHour / 24);
            const diffWeek = Math.floor(diffDay / 7);
            const diffMonth = Math.floor(diffDay / 30);
            const diffYear = Math.floor(diffDay / 365);

            if (diffYear >= 1) {
                return diffYear === 1 ? '1 year ago' : `${diffYear} years ago`;
            } else if (diffMonth >= 1) {
                return diffMonth === 1 ? '1 month ago' : `${diffMonth} months ago`;
            } else if (diffWeek >= 1) {
                return diffWeek === 1 ? '1 week ago' : `${diffWeek} weeks ago`;
            } else if (diffDay >= 1) {
                return diffDay === 1 ? '1 day ago' : `${diffDay} days ago`;
            } else if (diffHour >= 1) {
                return diffHour === 1 ? '1 hour ago' : `${diffHour} hours ago`;
            } else if (diffMin >= 1) {
                return diffMin === 1 ? '1 minute ago' : `${diffMin} minutes ago`;
            } else {
                return 'Just now';
            }
        }

        function toggleVideo(video, card) {
            const id = video.video_id;
            if (selectedVideos.has(id)) {
                selectedVideos.delete(id);
                card.classList.remove('selected');
            } else {
                selectedVideos.set(id, { title: video.title, thumbnail: video.thumbnail_url });
                card.classList.add('selected');
            }
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const count = selectedVideos.size;
            selectedCount.textContent = count;
            extractBtn.disabled = count === 0;
        }

        // Extract transcripts
        extractBtn.addEventListener('click', async () => {
            if (selectedVideos.size === 0) return;

            extractBtn.disabled = true;
            extractBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Extracting...</span>';

            transcriptPanel.classList.add('open');
            transcriptContent.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><p>Fetching transcripts...</p></div>';

            try {
                const ids = Array.from(selectedVideos.keys());
                const res = await fetch('/api/transcript', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ video_ids: ids })
                });

                const data = await res.json();
                renderTranscripts(data.results);
            } catch (err) {
                transcriptContent.innerHTML = '<div class="error-state"><i class="fas fa-exclamation-circle"></i><p>Failed to extract transcripts</p></div>';
            } finally {
                extractBtn.disabled = false;
                extractBtn.innerHTML = '<i class="fas fa-magic"></i><span>Get Transcripts</span><span class="count" id="selected-count">' + selectedVideos.size + '</span>';
            }
        });

        function renderTranscripts(results) {
            transcriptContent.innerHTML = '';

            // Store results for Phase 2
            window.transcriptResults = results;

            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'transcript-item';

                if (result.success) {
                    item.innerHTML = `
                        <div class="transcript-header">
                            <h3>${result.title}</h3>
                            <div class="transcript-actions">
                                <button class="btn btn-sm btn-ghost copy-btn" data-text="${encodeURIComponent(result.transcript)}">
                                    <i class="far fa-copy"></i> Copy
                                </button>
                                <button class="btn btn-sm btn-ghost download-btn" data-title="${result.title}" data-text="${encodeURIComponent(result.transcript)}">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </div>
                        <div class="transcript-text">${result.transcript}</div>
                    `;
                } else {
                    item.innerHTML = `
                        <div class="transcript-header error">
                            <h3>${result.title || result.video_id}</h3>
                        </div>
                        <div class="transcript-error">
                            <i class="fas fa-exclamation-triangle"></i>
                            ${result.error}
                        </div>
                    `;
                }

                transcriptContent.appendChild(item);
            });

            // Add Phase 2 button at the bottom
            const successResults = results.filter(r => r.success);
            if (successResults.length > 0) {
                const phase2Div = document.createElement('div');
                phase2Div.className = 'phase2-button-container';
                phase2Div.innerHTML = `
                    <button class="btn btn-phase2" id="goto-phase2">
                        <i class="fas fa-language"></i>
                        Move to Phase 2 - Translation
                        <i class="fas fa-arrow-right"></i>
                    </button>
                `;
                transcriptContent.appendChild(phase2Div);

                document.getElementById('goto-phase2').addEventListener('click', () => {
                    // Store successful transcripts in sessionStorage
                    sessionStorage.setItem('transcripts', JSON.stringify(successResults));
                    window.location.href = '/translate';
                });
            }

            // Attach copy/download handlers
            document.querySelectorAll('.copy-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const text = decodeURIComponent(btn.dataset.text);
                    navigator.clipboard.writeText(text);
                    btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                    setTimeout(() => btn.innerHTML = '<i class="far fa-copy"></i> Copy', 2000);
                });
            });

            document.querySelectorAll('.download-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const text = decodeURIComponent(btn.dataset.text);
                    const title = btn.dataset.title.replace(/[^a-z0-9]/gi, '_');
                    const blob = new Blob([text], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${title}.txt`;
                    a.click();
                    URL.revokeObjectURL(url);
                });
            });
        }

        // Event listeners
        document.getElementById('refresh-btn').addEventListener('click', () => loadVideos());

        document.getElementById('select-all-btn').addEventListener('click', () => {
            const cards = document.querySelectorAll('.video-card');
            const allSelected = Array.from(cards).every(c => c.classList.contains('selected'));

            cards.forEach(card => {
                const id = card.dataset.id;
                const title = card.querySelector('.video-title').textContent;
                const thumbnail = card.querySelector('img').src;

                if (allSelected) {
                    selectedVideos.delete(id);
                    card.classList.remove('selected');
                } else {
                    selectedVideos.set(id, { title, thumbnail });
                    card.classList.add('selected');
                }
            });
            updateSelectedCount();
        });

        document.getElementById('close-panel').addEventListener('click', () => {
            transcriptPanel.classList.remove('open');
        });

        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loadVideos(true);
        });

        // Initialize
        loadVideos();

        // ===== MODEL SELECTOR =====
        let currentModel = localStorage.getItem('selectedModel') || 'gemini-2.5-flash-lite';
        let availableModels = {};

        async function loadModels() {
            try {
                const res = await fetch('/api/models');
                const data = await res.json();
                availableModels = data.models;
                currentModel = data.current;
                localStorage.setItem('selectedModel', currentModel);
                renderModelDropdown();
                updateModelButton();
            } catch (err) {
                console.error('Failed to load models:', err);
                document.getElementById('current-model-name').textContent = 'Error';
            }
        }

        function renderModelDropdown() {
            const dropdown = document.getElementById('model-dropdown');
            let html = '';

            // Group by category
            const geminiModels = Object.entries(availableModels).filter(([k, v]) => v.category === 'gemini');
            const gemmaModels = Object.entries(availableModels).filter(([k, v]) => v.category === 'gemma');
            const groqModels = Object.entries(availableModels).filter(([k, v]) => v.category === 'groq');

            if (geminiModels.length > 0) {
                html += '<div class="model-category">Gemini Models</div>';
                geminiModels.forEach(([key, model]) => {
                    html += renderModelOption(key, model);
                });
            }

            if (gemmaModels.length > 0) {
                html += '<div class="model-category">Gemma Models (Open Source)</div>';
                gemmaModels.forEach(([key, model]) => {
                    html += renderModelOption(key, model);
                });
            }

            if (groqModels.length > 0) {
                html += '<div class="model-category">Groq Models (Fast)</div>';
                groqModels.forEach(([key, model]) => {
                    html += renderModelOption(key, model);
                });
            }

            dropdown.innerHTML = html;

            // Attach click handlers
            dropdown.querySelectorAll('.model-option').forEach(opt => {
                opt.addEventListener('click', () => switchModel(opt.dataset.model));
            });
        }

        function renderModelOption(key, model) {
            const isActive = key === currentModel;
            return `
                <div class="model-option ${isActive ? 'active' : ''}" data-model="${key}">
                    <span class="check-icon"><i class="fas fa-check"></i></span>
                    <div class="model-info">
                        <div class="model-name">${model.name}</div>
                        <div class="model-desc">${model.description}</div>
                    </div>
                </div>
            `;
        }

        function updateModelButton() {
            const model = availableModels[currentModel];
            const name = model ? model.name : currentModel;
            document.getElementById('current-model-name').textContent = name;
        }

        async function switchModel(modelName) {
            if (modelName === currentModel) return;

            try {
                const res = await fetch('/api/models/switch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: modelName })
                });
                const data = await res.json();

                if (data.success) {
                    currentModel = modelName;
                    localStorage.setItem('selectedModel', currentModel);
                    renderModelDropdown();
                    updateModelButton();
                    // Close dropdown
                    document.getElementById('model-selector').classList.remove('open');
                }
            } catch (err) {
                console.error('Failed to switch model:', err);
            }
        }

        // Toggle dropdown
        document.getElementById('model-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('model-selector').classList.toggle('open');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!document.getElementById('model-selector').contains(e.target)) {
                document.getElementById('model-selector').classList.remove('open');
            }
        });

        // Load models on page load
        loadModels();
    </script>
</body>

</html>