<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RafLocalizer - Translation</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <a href="/"
                style="display: flex; align-items: center; gap: 0.75rem; text-decoration: none; color: inherit;">
                <div class="logo-icon">
                    <i class="fab fa-youtube"></i>
                </div>
                <span class="logo-text">Raf<span class="accent">Localizer</span></span>
            </a>
        </div>
        <div class="header-actions">
            <!-- Model Selector -->
            <div class="model-selector" id="model-selector">
                <button class="model-btn" id="model-btn">
                    <span class="status-dot"></span>
                    <span id="current-model-name">Loading...</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="model-dropdown" id="model-dropdown">
                    <!-- Models will be injected here -->
                </div>
            </div>
            <span class="phase-badge"><i class="fas fa-language"></i> PHASE 2: TRANSLATION</span>
        </div>
    </header>

    <!-- Main Container -->
    <div class="translate-container">
        <!-- Status -->
        <div class="translate-status" id="status"></div>

        <!-- All transcripts listed vertically -->
        <div id="transcripts-list">
            <!-- Transcript cards injected here -->
        </div>
    </div>

    <!-- Floating Navigation Arrows -->
    <div class="nav-arrows">
        <button class="nav-arrow nav-arrow-up" id="scroll-top-btn" title="Scroll to Top">
            <i class="fas fa-chevron-up"></i>
        </button>
        <button class="nav-arrow nav-arrow-down" id="scroll-bottom-btn" title="Scroll to Bottom">
            <i class="fas fa-chevron-down"></i>
        </button>
    </div>

    <script>
        let transcripts = [];

        // Load transcripts from sessionStorage
        function init() {
            const stored = sessionStorage.getItem('transcripts');
            const status = document.getElementById('status');

            if (!stored) {
                status.innerHTML = '<i class="fas fa-exclamation-circle"></i> No transcripts found. <a href="/">Go back to extract transcripts</a>';
                status.className = 'translate-status error';
                return;
            }

            transcripts = JSON.parse(stored);
            renderAllTranscripts();
        }

        function renderAllTranscripts() {
            const container = document.getElementById('transcripts-list');
            container.innerHTML = '';

            transcripts.forEach((t, index) => {
                const card = document.createElement('div');
                card.className = 'transcript-card';
                card.innerHTML = `
                    <div class="transcript-card-header">
                        <h3><i class="fas fa-video"></i> ${t.title}</h3>
                    </div>
                    
                    <!-- Step 1: Original Transcript -->
                    <div class="translate-step">
                        <div class="step-header">
                            <span class="step-number">1</span>
                            <h4>Original Transcript</h4>
                            <div class="step-actions">
                                <button class="btn btn-sm btn-ghost copy-btn" data-target="original-${index}">
                                    <i class="far fa-copy"></i> Copy
                                </button>
                            </div>
                        </div>
                        <textarea id="original-${index}" class="step-textarea">${t.transcript}</textarea>
                    </div>

                    <!-- Step 2: Translate to English -->
                    <div class="translate-step">
                        <div class="step-header">
                            <span class="step-number">2</span>
                            <h4>English Translation</h4>
                            <div class="step-actions">
                                <button class="btn btn-sm btn-primary translate-to-en-btn" data-index="${index}">
                                    <i class="fas fa-language"></i> Translate to English
                                </button>
                                <button class="btn btn-sm btn-ghost copy-btn" data-target="english-${index}">
                                    <i class="far fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        <textarea id="english-${index}" class="step-textarea" placeholder="Click 'Translate to English' above. Edit text here to fix errors before translating to other languages."></textarea>
                    </div>

                    <!-- Step 3: Translate to Target Language -->
                    <div class="translate-step">
                        <div class="step-header">
                            <span class="step-number">3</span>
                            <h4>Final Translation</h4>
                            <div class="step-actions">
                                <select class="target-lang-select" id="lang-${index}">
                                    <option value="es">Spanish</option>
                                    <option value="pt">Portuguese</option>
                                    <option value="fr">French</option>
                                    <option value="de">German</option>
                                    <option value="it">Italian</option>
                                    <option value="ar">Arabic</option>
                                    <option value="hi">Hindi</option>
                                    <option value="zh-CN">Chinese</option>
                                    <option value="ja">Japanese</option>
                                    <option value="ko">Korean</option>
                                </select>
                                <button class="btn btn-sm btn-primary translate-final-btn" data-index="${index}">
                                    <i class="fas fa-language"></i> Translate
                                </button>
                                <button class="btn btn-sm btn-ghost copy-btn" data-target="final-${index}">
                                    <i class="far fa-copy"></i>
                                </button>
                                <button class="btn btn-sm btn-ghost download-btn" data-index="${index}">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </div>
                        <textarea id="final-${index}" class="step-textarea" placeholder="Translate from English (Step 2) to your target language. You can edit the result here."></textarea>
                    </div>

                    <!-- Step 4: Production Output -->
                    <div class="translate-step production-step">
                        <div class="step-header">
                            <span class="step-number">4</span>
                            <h4>üé¨ Production Output</h4>
                            <div class="step-actions">
                                <button class="btn btn-sm btn-primary generate-production-btn" data-index="${index}">
                                    <i class="fas fa-magic"></i> Generate
                                </button>
                            </div>
                        </div>
                        
                        <!-- Title -->
                        <div class="production-item">
                            <div class="production-label">
                                <span>üö® TITLE (Spanish, Caps)</span>
                                <button class="btn btn-sm btn-ghost copy-btn" data-target="prod-title-${index}">
                                    <i class="far fa-copy"></i> Copy
                                </button>
                            </div>
                            <textarea id="prod-title-${index}" class="production-textarea" placeholder="Spanish title will appear here..."></textarea>
                        </div>

                        <!-- Description -->
                        <div class="production-item">
                            <div class="production-label">
                                <span>üìÑ Description</span>
                                <button class="btn btn-sm btn-ghost copy-btn" data-target="prod-desc-${index}">
                                    <i class="far fa-copy"></i> Copy
                                </button>
                            </div>
                            <textarea id="prod-desc-${index}" class="production-textarea" placeholder="YouTube description will appear here..."></textarea>
                        </div>

                        <!-- Tags -->
                        <div class="production-item">
                            <div class="production-label">
                                <span>üè∑Ô∏è Tags</span>
                                <button class="btn btn-sm btn-ghost copy-btn" data-target="prod-tags-${index}">
                                    <i class="far fa-copy"></i> Copy
                                </button>
                            </div>
                            <textarea id="prod-tags-${index}" class="production-textarea" placeholder="YouTube tags will appear here..."></textarea>
                        </div>

                        <!-- Thumbnail -->
                        <div class="production-item">
                            <div class="production-label">
                                <span>üñºÔ∏è Thumbnail</span>
                                <div class="thumbnail-actions">
                                    <button class="btn btn-sm btn-ghost copy-thumbnail-btn" 
                                            data-video-id="${t.video_id}">
                                        <i class="far fa-copy"></i> Copy Image
                                    </button>
                                    <a href="https://img.youtube.com/vi/${t.video_id}/maxresdefault.jpg" 
                                       download="${t.video_id}_thumbnail.jpg" 
                                       class="btn btn-sm btn-ghost" 
                                       target="_blank">
                                        <i class="fas fa-download"></i> Download
                                    </a>
                                </div>
                            </div>
                            <div class="thumbnail-preview">
                                <img src="https://img.youtube.com/vi/${t.video_id}/maxresdefault.jpg" 
                                     alt="Video Thumbnail"
                                     onerror="this.src='https://img.youtube.com/vi/${t.video_id}/hqdefault.jpg'">
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });

            attachEventHandlers();

            // Auto-translate on page load
            autoTranslateAll();
        }

        function attachEventHandlers() {
            // Translate to English buttons
            document.querySelectorAll('.translate-to-en-btn').forEach(btn => {
                btn.addEventListener('click', () => translateToEnglish(btn.dataset.index));
            });

            // Translate to final language buttons
            document.querySelectorAll('.translate-final-btn').forEach(btn => {
                btn.addEventListener('click', () => translateToFinal(btn.dataset.index));
            });

            // Copy buttons
            document.querySelectorAll('.copy-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetId = btn.dataset.target;
                    const textarea = document.getElementById(targetId);
                    if (textarea && textarea.value) {
                        navigator.clipboard.writeText(textarea.value);
                        const original = btn.innerHTML;
                        btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                        setTimeout(() => btn.innerHTML = original, 2000);
                    }
                });
            });

            // Download buttons
            document.querySelectorAll('.download-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = btn.dataset.index;
                    const text = document.getElementById(`final-${index}`).value;
                    if (!text) return;

                    const title = transcripts[index].title.replace(/[^a-z0-9]/gi, '_');
                    const langSelect = document.getElementById(`lang-${index}`);
                    const lang = langSelect.options[langSelect.selectedIndex].text;

                    const blob = new Blob([text], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${title}_${lang}.txt`;
                    a.click();
                    URL.revokeObjectURL(url);
                });
            });

            // Generate Production buttons
            document.querySelectorAll('.generate-production-btn').forEach(btn => {
                btn.addEventListener('click', () => generateProduction(btn.dataset.index));
            });

            // Copy Thumbnail Image buttons
            document.querySelectorAll('.copy-thumbnail-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const videoId = btn.dataset.videoId;
                    const imageUrl = `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;

                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Copying...';
                    btn.disabled = true;

                    try {
                        // Fetch the image
                        const response = await fetch(imageUrl);
                        const blob = await response.blob();

                        // Copy to clipboard
                        await navigator.clipboard.write([
                            new ClipboardItem({ [blob.type]: blob })
                        ]);

                        btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                        setTimeout(() => {
                            btn.innerHTML = '<i class="far fa-copy"></i> Copy Image';
                            btn.disabled = false;
                        }, 2000);
                    } catch (err) {
                        console.error('Failed to copy image:', err);
                        // Fallback: copy URL
                        navigator.clipboard.writeText(imageUrl);
                        btn.innerHTML = '<i class="fas fa-check"></i> URL Copied';
                        setTimeout(() => {
                            btn.innerHTML = '<i class="far fa-copy"></i> Copy Image';
                            btn.disabled = false;
                        }, 2000);
                    }
                });
            });
        }

        // Auto-translate to English
        async function translateToEnglish(index) {
            const originalText = document.getElementById(`original-${index}`).value;
            const englishTextarea = document.getElementById(`english-${index}`);
            const btn = document.querySelector(`.translate-to-en-btn[data-index="${index}"]`);

            if (!originalText.trim()) return;

            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Translating...';
            }

            try {
                const res = await fetch('/api/translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: originalText, target_lang: 'en' })
                });
                const data = await res.json();

                if (data.success) {
                    englishTextarea.value = data.translated_text;
                    return data.translated_text;
                } else {
                    englishTextarea.value = 'Error: ' + data.error;
                }
            } catch (err) {
                englishTextarea.value = 'Translation failed';
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-language"></i> Translate to English';
                }
            }
            return null;
        }

        // Auto-translate to final language
        async function translateToFinal(index) {
            const englishText = document.getElementById(`english-${index}`).value;
            const targetLang = document.getElementById(`lang-${index}`).value;
            const finalTextarea = document.getElementById(`final-${index}`);
            const btn = document.querySelector(`.translate-final-btn[data-index="${index}"]`);

            if (!englishText.trim()) {
                finalTextarea.value = 'Please translate to English first (Step 2)';
                return;
            }

            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Translating...';
            }

            try {
                const res = await fetch('/api/translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: englishText, target_lang: targetLang })
                });
                const data = await res.json();

                if (data.success) {
                    finalTextarea.value = data.translated_text;
                } else {
                    finalTextarea.value = 'Error: ' + data.error;
                }
            } catch (err) {
                finalTextarea.value = 'Translation failed';
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-language"></i> Translate';
                }
            }
        }

        // Auto-translate all transcripts on page load
        async function autoTranslateAll() {
            const status = document.getElementById('status');
            status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Auto-translating all transcripts...';
            status.className = 'translate-status loading';

            for (let i = 0; i < transcripts.length; i++) {
                // Step 1: Translate to English
                const englishText = await translateToEnglish(i);

                // Small delay between API calls
                await new Promise(r => setTimeout(r, 500));

                // Step 2: Translate to Spanish (default)
                if (englishText) {
                    await translateToFinal(i);
                }

                // Small delay between transcripts
                if (i < transcripts.length - 1) {
                    await new Promise(r => setTimeout(r, 500));
                }
            }

            status.innerHTML = '<i class="fas fa-check-circle"></i> All translations complete. Edit the text as needed.';
            status.className = 'translate-status success';
        }

        // Generate Production Output
        async function generateProduction(index) {
            const title = transcripts[index].title;
            const englishText = document.getElementById(`english-${index}`).value;
            const spanishText = document.getElementById(`final-${index}`).value;
            const btn = document.querySelector(`.generate-production-btn[data-index="${index}"]`);

            if (!englishText.trim()) {
                alert('Please translate to English first (Step 2)');
                return;
            }

            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            }

            try {
                const res = await fetch('/api/generate-production', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: title,
                        english_text: englishText,
                        spanish_text: spanishText
                    })
                });

                const data = await res.json();

                if (data.success) {
                    document.getElementById(`prod-title-${index}`).value = data.title;
                    document.getElementById(`prod-desc-${index}`).value = data.description;
                    document.getElementById(`prod-tags-${index}`).value = data.tags;
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (err) {
                alert('Failed to generate production output');
                console.error(err);
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-magic"></i> Generate';
                }
            }
        }

        // Initialize
        init();

        // ===== MODEL SELECTOR =====
        let currentModel = localStorage.getItem('selectedModel') || 'gemini-2.5-flash-lite';
        let availableModels = {};

        async function loadModels() {
            try {
                const res = await fetch('/api/models');
                const data = await res.json();
                availableModels = data.models;
                currentModel = data.current;
                localStorage.setItem('selectedModel', currentModel);
                renderModelDropdown();
                updateModelButton();
            } catch (err) {
                console.error('Failed to load models:', err);
                document.getElementById('current-model-name').textContent = 'Error';
            }
        }

        function renderModelDropdown() {
            const dropdown = document.getElementById('model-dropdown');
            let html = '';

            const geminiModels = Object.entries(availableModels).filter(([k, v]) => v.category === 'gemini');
            const gemmaModels = Object.entries(availableModels).filter(([k, v]) => v.category === 'gemma');
            const groqModels = Object.entries(availableModels).filter(([k, v]) => v.category === 'groq');

            if (geminiModels.length > 0) {
                html += '<div class="model-category">Gemini Models</div>';
                geminiModels.forEach(([key, model]) => {
                    html += renderModelOption(key, model);
                });
            }

            if (gemmaModels.length > 0) {
                html += '<div class="model-category">Gemma Models (Open Source)</div>';
                gemmaModels.forEach(([key, model]) => {
                    html += renderModelOption(key, model);
                });
            }

            if (groqModels.length > 0) {
                html += '<div class="model-category">Groq Models (Fast)</div>';
                groqModels.forEach(([key, model]) => {
                    html += renderModelOption(key, model);
                });
            }

            dropdown.innerHTML = html;
            dropdown.querySelectorAll('.model-option').forEach(opt => {
                opt.addEventListener('click', () => switchModel(opt.dataset.model));
            });
        }

        function renderModelOption(key, model) {
            const isActive = key === currentModel;
            return `
                <div class="model-option ${isActive ? 'active' : ''}" data-model="${key}">
                    <span class="check-icon"><i class="fas fa-check"></i></span>
                    <div class="model-info">
                        <div class="model-name">${model.name}</div>
                        <div class="model-desc">${model.description}</div>
                    </div>
                </div>
            `;
        }

        function updateModelButton() {
            const model = availableModels[currentModel];
            document.getElementById('current-model-name').textContent = model ? model.name : currentModel;
        }

        async function switchModel(modelName) {
            if (modelName === currentModel) return;
            try {
                const res = await fetch('/api/models/switch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: modelName })
                });
                const data = await res.json();
                if (data.success) {
                    currentModel = modelName;
                    localStorage.setItem('selectedModel', currentModel);
                    renderModelDropdown();
                    updateModelButton();
                    document.getElementById('model-selector').classList.remove('open');
                }
            } catch (err) {
                console.error('Failed to switch model:', err);
            }
        }

        document.getElementById('model-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('model-selector').classList.toggle('open');
        });

        document.addEventListener('click', (e) => {
            if (!document.getElementById('model-selector').contains(e.target)) {
                document.getElementById('model-selector').classList.remove('open');
            }
        });

        loadModels();

        // ===== SCROLL NAVIGATION =====
        const scrollTopBtn = document.getElementById('scroll-top-btn');
        const scrollBottomBtn = document.getElementById('scroll-bottom-btn');

        scrollTopBtn.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        scrollBottomBtn.addEventListener('click', () => {
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        });

        // Show/hide arrows based on scroll position
        function updateArrowVisibility() {
            const scrollTop = window.scrollY;
            const scrollHeight = document.body.scrollHeight - window.innerHeight;

            // Show up arrow when scrolled down
            if (scrollTop > 200) {
                scrollTopBtn.classList.add('visible');
            } else {
                scrollTopBtn.classList.remove('visible');
            }

            // Show down arrow when not at bottom
            if (scrollTop < scrollHeight - 200) {
                scrollBottomBtn.classList.add('visible');
            } else {
                scrollBottomBtn.classList.remove('visible');
            }
        }

        window.addEventListener('scroll', updateArrowVisibility);
        window.addEventListener('resize', updateArrowVisibility);

        // Initial check
        setTimeout(updateArrowVisibility, 500);
    </script>
</body>

</html>